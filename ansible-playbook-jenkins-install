- hosts: jenkinsserver
  become: yes

  tasks:

  - name: Ensure apt-transport-https, ca-certificates and curl are present
    apt:
      name:
        - apt-transport-https
        - ca-certificates
        - curl
        - gnupg
      state: present
      update_cache: yes

  - name: Add Jenkins GPG key
    apt_key:
      url: https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key
      state: present

  - name: Add Jenkins apt repository
    apt_repository:
      repo: "deb https://pkg.jenkins.io/debian-stable binary/"
      state: present
      filename: jenkins

  - name: Update apt cache
    apt:
      update_cache: yes
      cache_valid_time: 3600

  - name: Install Java (OpenJDK 11)
    apt:
      name: openjdk-11-jdk
      state: present

  - name: Install Jenkins package
    apt:
      name: jenkins
      state: latest
    notify:
      - restart jenkins

  - name: Ensure Jenkins service is enabled and started
    service:
      name: jenkins
      state: started
      enabled: yes

  - name: Wait for Jenkins to be available on port 8080
    wait_for:
      host: 127.0.0.1
      port: 8080
      delay: 5
      timeout: 60

  - name: Read Jenkins initial admin password
    shell: cat /var/lib/jenkins/secrets/initialAdminPassword
    register: jenkins_initial_password
    changed_when: false
    failed_when: jenkins_initial_password.rc != 0 and jenkins_initial_password.stdout == ""

  - name: Print Jenkins initial admin password
    debug:
      msg: "Initial Jenkins admin password: {{ jenkins_initial_password.stdout }}"

  handlers:
    - name: restart jenkins
      service:
        name: jenkins
        state: restarted
